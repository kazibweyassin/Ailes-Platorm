// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(STUDENT)
  
  // Profile information
  phone         String?
  country       String?
  dateOfBirth   DateTime?
  gender        String?
  
  // Academic profile for scholarship matching
  fieldOfStudy  String?   // Major/Field of interest
  currentGPA    Float?
  degreeLevel   DegreeLevel?
  currentInstitution String?
  graduationYear Int?
  
  // Test scores
  ieltsScore    Float?
  toeflScore    Int?
  greScore      Int?
  gmatScore     Int?
  
  // Preferences
  interestedCountries String[]
  preferredIntake String? // Fall, Spring, etc.
  
  // Premium Subscription
  subscriptionTier SubscriptionTier @default(FREE)
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  subscriptionStartDate DateTime?
  subscriptionExpiresAt DateTime?
  subscriptionTransactionId String?
  
  // Account management
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  applications  Application[]
  savedScholarships SavedScholarship[]
  savedUniversities SavedUniversity[]
  documents     Document[]
  scholarshipMatches ScholarshipMatch[]

  copilotRequests CopilotRequest[]
  
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model University {
  id            String   @id @default(cuid())
  name          String
  country       String
  city          String?
  description   String?  @db.Text
  website       String?
  logo          String?
  ranking       Int?
  
  // Admission requirements
  minGPA        Float?
  englishTest   String?  // IELTS, TOEFL, etc.
  minEnglishScore Float?
  
  // Costs
  tuitionMin    Float?
  tuitionMax    Float?
  currency      String   @default("USD")
  
  // Programs
  programs      Program[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  applications  Application[]
  savedBy       SavedUniversity[]
  
  @@map("universities")
}

model Program {
  id            String   @id @default(cuid())
  name          String
  degree        DegreeLevel
  duration      Int      // in months
  description   String?  @db.Text
  requirements  String?  @db.Text
  
  universityId  String
  university    University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("programs")
}

model Scholarship {
  id            String   @id @default(cuid())
  name          String
  provider      String
  country       String?
  amount        Float?
  currency      String   @default("USD")
  type          ScholarshipType
  
  description   String?  @db.Text
  eligibility   String?  @db.Text
  deadline      DateTime?
  applicationOpenDate DateTime?
  website       String?
  applicationLink String?
  contactEmail  String?
  
  // Enhanced filtering
  fieldOfStudy  String[] // Engineering, Medicine, Business, etc.
  degreeLevel   DegreeLevel[]
  minGPA        Float?
  maxAge        Int?
  minAge        Int?
  
  // Target demographics
  forWomen      Boolean  @default(false)
  forAfrican    Boolean  @default(false)
  forUnderrepresented Boolean @default(false)
  targetCountries String[] // Countries where applicants must be from
  
  // Requirements tracking
  requiresIELTS Boolean  @default(false)
  minIELTS      Float?
  requiresTOEFL Boolean  @default(false)
  minTOEFL      Int?
  requiresGRE   Boolean  @default(false)
  requiresGMAT  Boolean  @default(false)
  
  // Additional info
  numberOfAwards Int?     // How many scholarships available
  renewableYears Int?     // Can be renewed for X years
  coversTuition Boolean  @default(false)
  coversLiving  Boolean  @default(false)
  coversTravel  Boolean  @default(false)
  coversBooks   Boolean  @default(false)
  
  // Metadata
  featured      Boolean  @default(false)
  verified      Boolean  @default(false)
  views         Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  applications  Application[]
  savedBy       SavedScholarship[]
  matches       ScholarshipMatch[]
  
  @@map("scholarships")
}

model Application {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  universityId  String?
  university    University? @relation(fields: [universityId], references: [id], onDelete: SetNull)
  
  scholarshipId String?
  scholarship   Scholarship? @relation(fields: [scholarshipId], references: [id], onDelete: SetNull)
  
  status        ApplicationStatus @default(DRAFT)
  programName   String?
  degreeLevel   DegreeLevel?
  intakeYear    Int?
  intakeSeason  String?
  
  // Application details
  notes         String?  @db.Text
  submittedAt   DateTime?
  decisionDate  DateTime?
  decisionResult String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("applications")
}

model SavedScholarship {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  scholarshipId String
  scholarship   Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)
  
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  
  @@unique([userId, scholarshipId])
  @@map("saved_scholarships")
}

model SavedUniversity {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  universityId  String
  university    University @relation(fields: [universityId], references: [id], onDelete: Cascade)
  
  notes         String?  @db.Text
  createdAt     DateTime @default(now())
  
  @@unique([userId, universityId])
  @@map("saved_universities")
}

// AI-powered scholarship matching
model ScholarshipMatch {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  scholarshipId String
  scholarship   Scholarship @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)
  
  matchScore    Int      // 0-100 percentage match
  matchReasons  String[] // Why this scholarship matches
  missingRequirements String[] // What user needs to qualify
  
  viewed        Boolean  @default(false)
  createdAt     DateTime @default(now())
  
  @@unique([userId, scholarshipId])
  @@map("scholarship_matches")
}

model Document {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  type          DocumentType
  url           String
  size          Int?     // in bytes
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("documents")
}

model Sponsor {
  id                String   @id @default(cuid())
  name              String
  email             String
  phone             String
  type              SponsorType // INDIVIDUAL or CORPORATE
  
  // Corporate details
  companyName       String?
  companyWebsite    String?
  
  // Sponsorship details
  tierName          String   // Application Support, Full Journey, etc.
  amount            Float
  anonymous         Boolean  @default(false)
  status            SponsorStatus @default(PENDING)
  
  // Scholar preferences
  preferredField    String?
  preferredCountry  String?
  message           String?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("sponsors")
}

// Enums
enum SponsorType {
  INDIVIDUAL
  CORPORATE
}

// CopilotRequest: stores user Copilot activation, payment, mapping, and consent
model CopilotRequest {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  finderData    Json     // Profile answers from ScholarshipFinderFlow
  paymentName   String
  paymentEmail  String
  paymentPhone  String
  paymentWhatsapp String
  paymentMethod String
  paymentStatus String   @default("pending")
  paymentTimestamp DateTime?
  status        String   @default("pending") // pending, processing, completed, failed
  mapping       Json?    // AI mapping result
  documents     Json?    // Generated documents metadata
  consentGiven  Boolean  @default(false)
  auditLog      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("copilot_requests")
}

enum SponsorStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
}

enum UserRole {
  STUDENT
  CONSULTANT
  ADMIN
}

enum DegreeLevel {
  BACHELOR
  MASTER
  PHD
  DIPLOMA
  CERTIFICATE
}

enum ScholarshipType {
  FULL
  PARTIAL
  TUITION
  LIVING
  RESEARCH
}

enum ApplicationStatus {
  DRAFT
  IN_PROGRESS
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WAITLISTED
}

enum DocumentType {
  TRANSCRIPT
  PASSPORT
  CV
  PERSONAL_STATEMENT
  RECOMMENDATION
  ENGLISH_TEST
  OTHER
}

enum SubscriptionTier {
  FREE
  PRO
  ELITE
}

enum SubscriptionStatus {
  INACTIVE
  PENDING
  ACTIVE
  EXPIRED
  CANCELLED
}

model StudentIntake {
  id            String   @id @default(cuid())
  
  // Personal Information
  firstName     String
  lastName      String
  email         String
  phone         String
  dateOfBirth   DateTime
  gender        String
  nationality   String
  currentCountry String
  city          String
  address       String?
  
  // Academic Background
  currentDegree String
  fieldOfStudy  String
  university    String
  gpa           String
  graduationYear String
  currentYear   String
  
  // Test Scores
  hasTestScores Boolean   @default(false)
  toeflScore    String?
  ieltsScore    String?
  greScore      String?
  gmatScore     String?
  satScore      String?
  
  // Study Preferences
  targetDegree  String
  targetCountries String
  targetFields  String
  preferredIntake String
  budgetRange   String
  
  // Financial Information
  financialNeed String
  fundingSource String
  expectedFunding String
  
  // Additional Information
  workExperience String?
  researchExperience String?
  publications  String?
  awards        String?
  volunteerWork String?
  languages     String?
  
  // Additional Context
  additionalInfo String?
  
  // Consent and Marketing
  consentDataUsage Boolean @default(false)
  marketingEmails Boolean @default(false)
  
  // Status tracking
  status        IntakeStatus @default(NEW)
  assignedTo    String?      // Admin user who is working on this
  notes         String?      // Internal notes from admin
  
  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("student_intakes")
}

enum IntakeStatus {
  NEW
  IN_REVIEW
  CONTACTED
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}
